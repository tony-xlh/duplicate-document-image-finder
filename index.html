<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vite + TS</title>
    <style>
      table, th, td {
        border: 1px solid black;
        border-collapse: collapse;
      }
      table img {
        max-width: 150px;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <h2>Duplicate Document Image Finder</h2>
      <button id="loadFileButton">Load Images</button>
      <button id="cropButton">Crop Images</button>
      <button id="findButton">Find Duplicate Images</button>
      <input style="display:none;" multiple type="file" id="file" onchange="loadImageFromFile();" accept=".jpg,.jpeg,.png,.bmp" />
      <div class="images">
      </div>
      <img id="processing"/>
    </div>
    <script type="module" src="/src/main.ts"></script>
    <script>
      let finder;
      
      window.onload = function(){
        finder = new DuplicateDocumentImageFinder();
        console.log(finder);
        registerEvents();
      }

      function registerEvents(){
        document.getElementById("loadFileButton").addEventListener("click",function(){
          document.getElementById("file").click();
        })
        document.getElementById("findButton").addEventListener("click",function(){
          findDuplicateImages();
        })
      }

      async function findDuplicateImages(){
        let tbody = document.getElementsByTagName("tbody")[0];
        let images = [];
        for (let index = 0; index < tbody.children.length; index++) {
          const tr = tbody.children[index];
          const img = tr.getElementsByTagName("img")[0];
          images.push(img);
        }
        if (images.length>1) {
          //let similar = await finder.detect(images[0],images[1]);
          //console.log(similar);
          const callback = (info) => {
            console.log(info);
          }
          let duplicates = await finder.find(images,undefined,callback);
          console.log(duplicates);
          for (let index = 0; index < images.length; index++) {
            const img = images[index];
            const tr = img.parentElement.parentElement;
            const statusCell = tr.getElementsByTagName("td")[1];
            if (duplicates.indexOf(img) != -1) {
              statusCell.innerText = "Yes";
            }else{
              statusCell.innerText = "No";
            }
          }
        }
      }

      async function loadImageFromFile(){
        let fileInput = document.getElementById("file");
        let files = fileInput.files;
        if (files.length == 0) {
          return;
        }
        console.log(files);
        let table = templateTable();
        let body = table.getElementsByTagName("tbody")[0];
        for (let index = 0; index < files.length; index++) {
          const file = files[index];
          let dataURL = await readFileAsDataURL(file);
          let row = document.createElement("tr");
          let imageCell = document.createElement("td");
          let statusCell = document.createElement("td");
          let img = document.createElement("img");
          img.src = dataURL;
          imageCell.appendChild(img);
          row.appendChild(imageCell);
          row.appendChild(statusCell);
          body.appendChild(row);
        }
        let imagesContainer = document.getElementsByClassName("images")[0];
        imagesContainer.innerHTML = table.outerHTML;
      }

      function readFileAsDataURL(file){
        return new Promise((resolve, reject) => {
          let fileReader = new FileReader();
          fileReader.onload = function(e){
            resolve(e.target.result);
          };
          fileReader.onerror = function () {
            console.warn('oops, something went wrong.');
            reject("error");
          };
          fileReader.readAsDataURL(file);
        })
      }

      function templateTable(){
        let table = document.createElement("table");
        let head = document.createElement("thead");
        let headRow = document.createElement("tr");
        let th1 = document.createElement("th");
        th1.innerText = "Image";
        let th2 = document.createElement("th");
        th2.innerText = "Is Duplicate";
        headRow.appendChild(th1);
        headRow.appendChild(th2);
        head.appendChild(headRow);
        let body = document.createElement("tbody");
        table.appendChild(head);
        table.appendChild(body);
        return table;
      }
    </script>
  </body>
</html>
